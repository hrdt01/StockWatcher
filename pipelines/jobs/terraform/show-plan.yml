parameters:
  - name: terraformPath
    type: string
  - name: environmentServiceNameAzureRM
    type: string    
  - name: tfPlanName
    type: string
    default: ''     
  - name: toolName
    type: string
    default: ''     

steps:
- task: TerraformTaskV4@4
  name: TerraformShow
  displayName: 'Terraform: show plan for ${{ parameters.toolName }}'
  inputs:
    provider: 'azurerm'
    command: 'show'
    commandOptions: '-no-color ${{ parameters.tfPlanName }}'
    environmentServiceNameAzureRM: ${{ parameters.environmentServiceNameAzureRM }} 
    outputTo: 'file'
    outputFormat: 'default'
    fileName: '${{ parameters.terraformPath }}/TerraformPlan_${{ parameters.toolName }}.md'
    workingDirectory: '${{ parameters.terraformPath }}'

# Display plan in the pipeline build summary
- task: Bash@3
  displayName: 'Project plan summary for ${{ parameters.toolName }}'
  inputs:
    targetType: 'inline'
    workingDirectory: '${{ parameters.terraformPath }}'
    script: |
      ls -la
      sed -i '1 i\```' TerraformPlan_${{ parameters.toolName }}.md
      echo '```' >> TerraformPlan_${{ parameters.toolName }}.md
      echo "##vso[task.uploadsummary]${{ parameters.terraformPath }}/TerraformPlan_${{ parameters.toolName }}.md"    

